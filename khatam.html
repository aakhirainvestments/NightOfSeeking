<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NIGHT OF SEEKING ‚Äî Khatam</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf6f0;
      --text: #1a1a1a;
      --accent: #6b1a2a;
      --accent-light: rgba(107, 26, 42, 0.08);
      --card-bg: #ffffff;
      --border: rgba(107, 26, 42, 0.15);
      --muted: #999;
      --free-bg: #ffffff;
      --half-bg: #fff8e8;
      --full-bg: #f0f0f0;
      --done-bg: #eaf5ea;
    }

    body.male {
      --bg: #1e3320;
      --text: #f5f0e8;
      --accent: #c9b99a;
      --accent-light: rgba(201, 185, 154, 0.1);
      --card-bg: #2c4a2e;
      --border: rgba(201, 185, 154, 0.2);
      --muted: #8aaa8a;
      --free-bg: #2c4a2e;
      --half-bg: #3a4a20;
      --full-bg: #253525;
      --done-bg: #1a3a1c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Montserrat, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 0 0 80px; }

    .header { padding: 50px 24px 30px; text-align: center; border-bottom: 1px solid var(--border); }
    .brand { font-size: 11px; font-weight: 500; letter-spacing: 5px; text-transform: uppercase; color: var(--accent); margin-bottom: 12px; }
    .header h1 { font-family: "Cormorant Garamond", serif; font-size: clamp(36px, 8vw, 56px); font-weight: 300; line-height: 1.1; color: var(--text); margin-bottom: 8px; }
    .header h1 em { font-style: italic; color: var(--accent); }
    .divider { width: 40px; height: 1px; background: var(--accent); margin: 16px auto; }
    .header p { font-size: 13px; color: var(--muted); letter-spacing: 1px; }

    .progress-section { max-width: 600px; margin: 28px auto 0; padding: 0 20px; }
    .progress-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
    .progress-label { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent); }
    .progress-fraction { font-family: "Cormorant Garamond", serif; font-size: 22px; color: var(--text); }
    .progress-track { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.6s ease; }
    .progress-sub { display: flex; justify-content: space-between; margin-top: 8px; }
    .progress-sub span { font-size: 10px; letter-spacing: 1px; color: var(--muted); }

    .legend { max-width: 600px; margin: 16px auto 0; padding: 0 20px; display: flex; gap: 16px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); letter-spacing: 1px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .dot-free { background: #4caf50; }
    .dot-half { background: #ff9800; }
    .dot-full { background: #aaa; }
    .dot-done { background: var(--accent); }

    .refresh-bar { max-width: 600px; margin: 16px auto 0; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .refresh-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: Montserrat, sans-serif; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; padding: 8px 16px; cursor: pointer; border-radius: 1px; transition: border-color 0.2s, color 0.2s; }
    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
    .last-updated { font-size: 10px; color: var(--muted); letter-spacing: 1px; }

    .juz-section { max-width: 600px; margin: 20px auto 0; padding: 0 20px; }
    .juz-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

    .juz-card { background: var(--free-bg); border: 1px solid var(--border); border-radius: 2px; padding: 14px 12px; cursor: pointer; transition: transform 0.15s, border-color 0.2s; position: relative; overflow: hidden; }
    .juz-card:hover { transform: translateY(-1px); border-color: var(--accent); }
    .juz-card.half { background: var(--half-bg); }
    .juz-card.full { background: var(--full-bg); }
    .juz-card.done { background: var(--done-bg); cursor: default; }
    .juz-card.done:hover { transform: none; }

    .juz-number { font-family: "Cormorant Garamond", serif; font-size: 28px; font-weight: 300; color: var(--text); line-height: 1; margin-bottom: 4px; }
    .juz-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .juz-status { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

    .juz-card:not(.half):not(.full):not(.done) .status-dot { background: #4caf50; }
    .juz-card:not(.half):not(.full):not(.done) .juz-status { color: #4caf50; }
    .juz-card.half .status-dot { background: #ff9800; }
    .juz-card.half .juz-status { color: #ff9800; }
    .juz-card.full .status-dot { background: #aaa; }
    .juz-card.full .juz-status { color: #aaa; }
    .juz-card.done .status-dot { background: var(--accent); }
    .juz-card.done .juz-status { color: var(--accent); }
    .done-check { position: absolute; top: 8px; right: 8px; font-size: 14px; }

    .loading { text-align: center; padding: 60px; font-size: 13px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; grid-column: 1 / -1; }

    /* MODAL */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: flex-end; justify-content: center; }
    .modal-overlay.open { display: flex; animation: overlayIn 0.2s ease; }
    @keyframes overlayIn { from { opacity: 0; } to { opacity: 1; } }
    .modal { background: var(--bg); width: 100%; max-width: 600px; border-radius: 4px 4px 0 0; padding: 28px 24px 40px; animation: slideUp 0.25s ease; border-top: 1px solid var(--border); }
    @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .modal-title { font-family: "Cormorant Garamond", serif; font-size: 26px; font-weight: 400; color: var(--text); margin-bottom: 4px; }
    .modal-divider { width: 30px; height: 1px; background: var(--accent); margin: 12px 0 20px; }
    .modal-subtitle { font-size: 12px; color: var(--muted); letter-spacing: 1px; margin-bottom: 20px; }

    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent); margin-bottom: 6px; }
    .field input { width: 100%; padding: 12px 14px; background: transparent; border: 1px solid var(--border); color: var(--text); font-family: Montserrat, sans-serif; font-size: 14px; outline: none; border-radius: 1px; transition: border-color 0.2s; }
    .field input:focus { border-color: var(--accent); }
    .field input::placeholder { color: var(--muted); }

    .claim-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .claim-option { padding: 14px; border: 1px solid var(--border); background: transparent; color: var(--text); font-family: Montserrat, sans-serif; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; border-radius: 1px; transition: background 0.2s, border-color 0.2s; text-align: center; }
    .claim-option:hover, .claim-option.selected { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .claim-option:disabled { opacity: 0.3; cursor: not-allowed; }
    .claim-option:disabled:hover { background: transparent; border-color: var(--border); color: var(--text); }

    .modal-btn { width: 100%; padding: 14px; background: var(--accent); color: var(--bg); border: none; font-family: Montserrat, sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; border-radius: 1px; transition: opacity 0.2s; margin-top: 4px; }
    .modal-btn:hover { opacity: 0.85; }
    .modal-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .modal-btn-secondary { width: 100%; padding: 12px; background: transparent; color: var(--muted); border: 1px solid var(--border); font-family: Montserrat, sans-serif; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; border-radius: 1px; margin-top: 8px; }

    .modal-feedback { font-size: 12px; text-align: center; margin-top: 10px; min-height: 18px; color: var(--accent); letter-spacing: 1px; }
    .complete-info { background: var(--accent-light); border: 1px solid var(--border); padding: 14px; border-radius: 1px; font-size: 13px; color: var(--text); margin-bottom: 14px; line-height: 1.6; }
  </style>
</head>
<body>

  <div class="header">
    <p class="brand">Aakhira Investments</p>
    <h1>Quran <em>Khatam</em></h1>
    <div class="divider"></div>
    <p>Claim a juz and complete it on the night üåô</p>
  </div>

  <div class="progress-section">
    <div class="progress-header">
      <span class="progress-label">Khatam Progress</span>
      <span class="progress-fraction" id="progress-fraction">‚Äî / 30</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>
    <div class="progress-sub">
      <span id="progress-claimed">0 juz claimed</span>
      <span id="progress-completed">0 completed</span>
    </div>
  </div>

  <div class="legend">
    <div class="legend-item"><span class="legend-dot dot-free"></span> Free</div>
    <div class="legend-item"><span class="legend-dot dot-half"></span> Half taken</div>
    <div class="legend-item"><span class="legend-dot dot-full"></span> Fully claimed</div>
    <div class="legend-item"><span class="legend-dot dot-done"></span> Completed ‚úì</div>
  </div>

  <div class="refresh-bar">
    <span class="last-updated" id="last-updated">Loading...</span>
    <button class="refresh-btn" onclick="loadKhatam()">‚Üª Refresh</button>
  </div>

  <div class="juz-section">
    <div class="juz-grid" id="juz-grid">
      <div class="loading">Loading juz...</div>
    </div>
  </div>

  <!-- CLAIM MODAL -->
  <div class="modal-overlay" id="claim-modal" onclick="closeModal(event)">
    <div class="modal">
      <p class="modal-title" id="modal-juz-title">Juz ‚Äî</p>
      <div class="modal-divider"></div>
      <p class="modal-subtitle" id="modal-status-info"></p>
      <div class="field">
        <label>Your Name</label>
        <input type="text" id="claim-name" placeholder="As it appears on your ticket">
      </div>
      <div class="field">
        <label>Claim Type</label>
        <div class="claim-options">
          <button class="claim-option selected" id="opt-full" onclick="selectClaimType('full')">Full Juz</button>
          <button class="claim-option" id="opt-half" onclick="selectClaimType('half')">Half Juz</button>
        </div>
      </div>
      <button class="modal-btn" id="claim-btn" onclick="submitClaim()">Claim Juz</button>
      <button class="modal-btn-secondary" onclick="closeAllModals()">Cancel</button>
      <p class="modal-feedback" id="claim-feedback"></p>
    </div>
  </div>

  <!-- COMPLETE MODAL -->
  <div class="modal-overlay" id="complete-modal" onclick="closeModal(event)">
    <div class="modal">
      <p class="modal-title" id="complete-juz-title">Mark Complete</p>
      <div class="modal-divider"></div>
      <div class="complete-info">Only the person who claimed this juz can mark it as complete. Enter your name exactly as you used when claiming.</div>
      <div class="field">
        <label>Your Name</label>
        <input type="text" id="complete-name" placeholder="Exactly as when you claimed">
      </div>
      <button class="modal-btn" id="complete-btn" onclick="submitComplete()">Mark as Complete ‚úì</button>
      <button class="modal-btn-secondary" onclick="closeAllModals()">Cancel</button>
      <p class="modal-feedback" id="complete-feedback"></p>
    </div>
  </div>

<script>
  var WEB_APP_URL = "https://script.google.com/macros/s/AKfycbygzZSNdSrUQfzs86AyQKQHkk0FpMrcab-Aw9JrUy7OVOIPdsQYnQ90U0ra6vgWASh70A/exec";
  var params = new URLSearchParams(window.location.search);
  var GENDER = (params.get("gender") || "FEMALE").toUpperCase();
  if (GENDER === "MALE") document.body.classList.add("male");

  var juzData = [];
  var selectedJuz = null;
  var selectedClaimType = "full";

  function loadKhatam() {
    fetch(WEB_APP_URL + "?action=getKhatam&gender=" + GENDER)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        juzData = data.juzList || [];
        renderGrid();
        updateProgress();
        document.getElementById("last-updated").innerText =
          "Updated " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      })
      .catch(function() {
        document.getElementById("juz-grid").innerHTML = '<div class="loading">Could not load. Check connection.</div>';
      });
  }

  function renderGrid() {
    var html = "";
    juzData.forEach(function(j) {
      var cls = "juz-card";
      var statusText = "Free";
      var doneCheck = "";

      if (j.completed) {
        cls += " done"; statusText = "Completed"; doneCheck = '<span class="done-check">‚úì</span>';
      } else if (j.status === "Full") {
        cls += " full"; statusText = "Full";
      } else if (j.status === "Half") {
  cls += " half"; statusText = "2nd half free";
}

      var onclick = !j.completed ? 'onclick="openJuzModal(' + j.juz + ')"' : '';
      html += '<div class="' + cls + '" ' + onclick + '>'
        + doneCheck
        + '<div class="juz-number">' + j.juz + '</div>'
        + '<div class="juz-label">Juz</div>'
        + '<div class="juz-status"><span class="status-dot"></span>' + statusText + '</div>'
        + '</div>';
    });
    document.getElementById("juz-grid").innerHTML = html;
  }

  function updateProgress() {
    var claimed = juzData.filter(function(j) { return j.status !== "Free"; }).length;
    var completed = juzData.filter(function(j) { return j.completed; }).length;
    var pct = Math.round((completed / 30) * 100);
    document.getElementById("progress-fill").style.width = pct + "%";
    document.getElementById("progress-fraction").innerText = completed + " / 30";
    document.getElementById("progress-claimed").innerText = claimed + " juz claimed";
    document.getElementById("progress-completed").innerText = completed + " completed";
  }

  function openJuzModal(juzNum) {
    selectedJuz = juzData.find(function(j) { return j.juz === juzNum; });
    if (!selectedJuz) return;

    if (selectedJuz.status === "Full") {
      document.getElementById("complete-juz-title").innerText = "Juz " + juzNum + " ‚Äî Mark Complete";
      document.getElementById("complete-name").value = "";
      document.getElementById("complete-feedback").innerText = "";
      document.getElementById("complete-btn").disabled = false;
      document.getElementById("complete-modal").classList.add("open");
      return;
    }

    document.getElementById("modal-juz-title").innerText = "Juz " + juzNum;
    document.getElementById("claim-name").value = "";
    document.getElementById("claim-feedback").innerText = "";
    document.getElementById("claim-btn").disabled = false;
    selectedClaimType = "full";

    var isHalfTaken = selectedJuz.status === "Half";
    document.getElementById("opt-full").disabled = isHalfTaken;
    document.getElementById("opt-full").classList.toggle("selected", !isHalfTaken);
    document.getElementById("opt-half").classList.toggle("selected", isHalfTaken);
    if (isHalfTaken) selectedClaimType = "half";

    document.getElementById("modal-status-info").innerText = isHalfTaken
  ? "The 1st half is already claimed ‚Äî you will be claiming the 2nd half."
  : "This juz is free ‚Äî claim the full juz or just the 1st half.";

    document.getElementById("claim-modal").classList.add("open");
  }

  function selectClaimType(type) {
    if (type === "full" && document.getElementById("opt-full").disabled) return;
    selectedClaimType = type;
    document.getElementById("opt-full").classList.toggle("selected", type === "full");
    document.getElementById("opt-half").classList.toggle("selected", type === "half");
  }

  function submitClaim() {
    var name = document.getElementById("claim-name").value.trim();
    var feedback = document.getElementById("claim-feedback");
    var btn = document.getElementById("claim-btn");
    if (!name) { feedback.innerText = "Please enter your name"; return; }
    btn.disabled = true;
    feedback.innerText = "Claiming...";
    var isHalf = selectedClaimType === "half";
    fetch(WEB_APP_URL + "?action=claimJuz&juz=" + selectedJuz.juz + "&name=" + encodeURIComponent(name) + "&half=" + isHalf + "&gender=" + GENDER)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          feedback.innerText = "Claimed! ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá ÿÆŸäÿ±ÿß ü§ç";
          setTimeout(function() { closeAllModals(); loadKhatam(); }, 1200);
        } else {
          feedback.innerText = data.error || "Something went wrong";
          btn.disabled = false;
        }
      })
      .catch(function() { feedback.innerText = "Could not claim. Check your connection."; btn.disabled = false; });
  }

  function submitComplete() {
    var name = document.getElementById("complete-name").value.trim();
    var feedback = document.getElementById("complete-feedback");
    var btn = document.getElementById("complete-btn");
    if (!name) { feedback.innerText = "Please enter your name"; return; }

    var claimer1 = (selectedJuz.claimer1Name || "").trim().toLowerCase();
    var claimer2 = (selectedJuz.claimer2Name || "").trim().toLowerCase();
    if (name.toLowerCase() !== claimer1 && name.toLowerCase() !== claimer2) {
      feedback.innerText = "Name doesn't match the claimer. Check spelling.";
      return;
    }

    btn.disabled = true;
    feedback.innerText = "Marking complete...";
    fetch(WEB_APP_URL + "?action=completeJuz&juz=" + selectedJuz.juz + "&name=" + encodeURIComponent(name) + "&gender=" + GENDER)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          feedback.innerText = "BarakAllahu feek! Marked complete üåô";
          setTimeout(function() { closeAllModals(); loadKhatam(); }, 1200);
        } else {
          feedback.innerText = data.error || "Something went wrong";
          btn.disabled = false;
        }
      })
      .catch(function() { feedback.innerText = "Could not update. Check connection."; btn.disabled = false; });
  }

  function closeModal(event) { if (event.target === event.currentTarget) closeAllModals(); }

  function closeAllModals() {
    document.querySelectorAll(".modal-overlay").forEach(function(m) { m.classList.remove("open"); });
    document.getElementById("claim-btn").disabled = false;
    document.getElementById("complete-btn").disabled = false;
    selectedJuz = null;
  }

  loadKhatam();
  setInterval(loadKhatam, 60000);
</script>
</body>
</html>
