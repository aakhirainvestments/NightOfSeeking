<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NIGHT OF SEEKING ‚Äî Quran Khatam</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf6f0;
      --text: #1a1a1a;
      --accent: #6b1a2a;
      --accent-light: rgba(107, 26, 42, 0.08);
      --accent-mid: rgba(107, 26, 42, 0.2);
      --card-bg: #ffffff;
      --border: rgba(107, 26, 42, 0.15);
      --muted: #999;
      --free: #ffffff;
      --half: #fff8e1;
      --full: #f0f7f0;
      --completed: #6b1a2a;
    }

    body.male {
      --bg: #1e3320;
      --text: #f5f0e8;
      --accent: #c9b99a;
      --accent-light: rgba(201, 185, 154, 0.08);
      --accent-mid: rgba(201, 185, 154, 0.2);
      --card-bg: #2c4a2e;
      --border: rgba(201, 185, 154, 0.2);
      --muted: #8aaa8a;
      --free: #2c4a2e;
      --half: #3a4a20;
      --full: #1a3a20;
      --completed: #c9b99a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Montserrat, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 0 0 80px;
    }

    .header {
      padding: 50px 24px 30px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    .brand {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 5px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .header h1 {
      font-family: "Cormorant Garamond", serif;
      font-size: clamp(36px, 8vw, 56px);
      font-weight: 300;
      line-height: 1.1;
      color: var(--text);
      margin-bottom: 8px;
    }

    .header h1 em { font-style: italic; color: var(--accent); }

    .divider {
      width: 40px;
      height: 1px;
      background: var(--accent);
      margin: 16px auto;
    }

    .header p {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* LEGEND */
    .legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      max-width: 600px;
      margin: 20px auto 0;
      padding: 0 20px;
      font-size: 11px;
      letter-spacing: 1px;
      color: var(--muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .dot-free { background: var(--border); border: 1px solid var(--border); }
    .dot-half { background: #f5c842; }
    .dot-full { background: #4caf50; }
    .dot-completed { background: var(--accent); }

    /* STATS */
    .stats-bar {
      max-width: 600px;
      margin: 20px auto 0;
      padding: 0 20px;
      display: flex;
      gap: 10px;
    }

    .stat {
      flex: 1;
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 12px 8px;
      text-align: center;
      border-radius: 2px;
    }

    .stat-number {
      font-family: "Cormorant Garamond", serif;
      font-size: 28px;
      font-weight: 300;
      color: var(--accent);
      line-height: 1;
    }

    .stat-label {
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 4px;
    }

    /* KHATAM TABS */
    .khatam-tabs {
      display: flex;
      gap: 4px;
      max-width: 600px;
      margin: 20px auto 0;
      padding: 0 20px;
      overflow-x: auto;
    }

    .khatam-tab {
      padding: 8px 20px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: Montserrat, sans-serif;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 1px;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .khatam-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    .khatam-tab.locked {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* REFRESH */
    .refresh-bar {
      max-width: 600px;
      margin: 12px auto 0;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .refresh-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: Montserrat, sans-serif;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 1px;
      transition: border-color 0.2s, color 0.2s;
    }

    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }

    .last-updated {
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* JUZ GRID */
    .juz-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      max-width: 600px;
      margin: 20px auto 0;
      padding: 0 20px;
    }

    .juz-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 16px 14px;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.1s, background 0.2s;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .juz-card:hover { border-color: var(--accent); transform: translateY(-1px); }
    .juz-card.full { border-color: #4caf50; cursor: default; }
    .juz-card.full:hover { transform: none; }
    .juz-card.half { border-color: #f5c842; }
    .juz-card.completed { border-color: var(--accent); background: var(--accent-light); }

    .juz-number {
      font-family: "Cormorant Garamond", serif;
      font-size: 28px;
      font-weight: 300;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 6px;
    }

    .juz-label {
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .juz-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      position: absolute;
      top: 12px;
      right: 12px;
    }

    .status-free .juz-status-dot { background: var(--border); }
    .status-half .juz-status-dot { background: #f5c842; }
    .status-full .juz-status-dot { background: #4caf50; }
    .status-completed .juz-status-dot { background: var(--accent); }

    .juz-claimers {
      font-size: 11px;
      color: var(--text);
      line-height: 1.6;
      min-height: 18px;
    }

    .claimer-line {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .half-label {
      font-size: 9px;
      letter-spacing: 1px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .completed-star {
      font-size: 11px;
      margin-top: 4px;
      color: var(--accent);
    }

    /* MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: flex-end;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--bg);
      border-radius: 12px 12px 0 0;
      padding: 28px 24px 40px;
      width: 100%;
      max-width: 500px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-title {
      font-family: "Cormorant Garamond", serif;
      font-size: 28px;
      font-weight: 400;
      color: var(--text);
      margin-bottom: 4px;
    }

    .modal-subtitle {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    .modal-field {
      margin-bottom: 14px;
    }

    .modal-field label {
      display: block;
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .modal-field input {
      width: 100%;
      padding: 12px 14px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: Montserrat, sans-serif;
      font-size: 14px;
      outline: none;
      border-radius: 1px;
      transition: border-color 0.2s;
    }

    .modal-field input:focus { border-color: var(--accent); }
    .modal-field input::placeholder { color: var(--muted); }

    .claim-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }

    .claim-option {
      padding: 14px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 2px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .claim-option:hover { border-color: var(--accent); }
    .claim-option.selected { background: var(--accent); border-color: var(--accent); color: var(--bg); }

    .claim-option-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 3px;
    }

    .claim-option-desc {
      font-size: 10px;
      opacity: 0.7;
      letter-spacing: 1px;
    }

    .modal-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-family: Montserrat, sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 1px;
      margin-bottom: 10px;
      transition: opacity 0.2s;
    }

    .modal-btn:hover { opacity: 0.85; }
    .modal-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .modal-cancel {
      width: 100%;
      padding: 12px;
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      font-family: Montserrat, sans-serif;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 1px;
    }

    .modal-feedback {
      font-size: 12px;
      text-align: center;
      margin-top: 8px;
      min-height: 18px;
      color: var(--accent);
      letter-spacing: 1px;
    }

    /* COMPLETE MODAL */
    .complete-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .complete-btn {
      width: 100%;
      padding: 12px;
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      font-family: Montserrat, sans-serif;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 1px;
      transition: all 0.2s;
    }

    .complete-btn:hover { background: var(--accent); color: var(--bg); }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
    }
  </style>
</head>
<body>

  <div class="header">
    <p class="brand">Aakhira Investments</p>
    <h1>Quran <em>Khatam</em></h1>
    <div class="divider"></div>
    <p>Night of Seeking ‚Äî Sign up for your juz</p>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot dot-free"></div> Available</div>
    <div class="legend-item"><div class="legend-dot dot-half"></div> Half claimed</div>
    <div class="legend-item"><div class="legend-dot dot-full"></div> Fully claimed</div>
    <div class="legend-item"><div class="legend-dot dot-completed"></div> Completed ‚úì</div>
  </div>

  <div class="stats-bar">
    <div class="stat">
      <div class="stat-number" id="stat-free">‚Äî</div>
      <div class="stat-label">Available</div>
    </div>
    <div class="stat">
      <div class="stat-number" id="stat-claimed">‚Äî</div>
      <div class="stat-label">Claimed</div>
    </div>
    <div class="stat">
      <div class="stat-number" id="stat-completed">‚Äî</div>
      <div class="stat-label">Completed</div>
    </div>
  </div>

  <div class="khatam-tabs" id="khatam-tabs"></div>

  <div class="refresh-bar">
    <span class="last-updated" id="last-updated">Loading...</span>
    <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
  </div>

  <div class="juz-grid" id="juz-grid">
    <div class="loading">Loading khatam...</div>
  </div>

  <!-- CLAIM MODAL -->
  <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal" id="modal">
      <p class="modal-title" id="modal-title">Juz 1</p>
      <p class="modal-subtitle" id="modal-subtitle">Choose how you'd like to claim</p>

      <div class="modal-field">
        <label>Your Name</label>
        <input type="text" id="claim-name" placeholder="First name" maxlength="60">
      </div>

      <div class="claim-options" id="claim-options">
        <div class="claim-option selected" id="opt-full" onclick="selectOption('full')">
          <div class="claim-option-title">Full Juz</div>
          <div class="claim-option-desc">I'll read all 20 pages</div>
        </div>
        <div class="claim-option" id="opt-half" onclick="selectOption('half')">
          <div class="claim-option-title">Half Juz</div>
          <div class="claim-option-desc">I'll read 10 pages</div>
        </div>
      </div>

      <button class="modal-btn" id="claim-btn" onclick="claimJuz()">Claim Juz</button>
      <button class="modal-cancel" onclick="closeModalDirect()">Cancel</button>
      <p class="modal-feedback" id="modal-feedback"></p>

      <div class="complete-section" id="complete-section" style="display:none;">
        <button class="complete-btn" onclick="completeJuz()">‚úì Mark My Juz as Complete</button>
      </div>
    </div>
  </div>

<script>
  var WEB_APP_URL = "https://script.google.com/macros/s/AKfycbygzZSNdSrUQfzs86AyQKQHkk0FpMrcab-Aw9JrUy7OVOIPdsQYnQ90U0ra6vgWASh70A/exec";

  var params = new URLSearchParams(window.location.search);
  var GENDER = (params.get("gender") || "FEMALE").toUpperCase();
  if (GENDER === "MALE") document.body.classList.add("male");

  // Each khatam is a set of 30 juz in the sheet
  // We handle multiple khatams by offsetting juz numbers: khatam 1 = juz 1-30, khatam 2 = juz 31-60 etc.
  var currentKhatam = 1;
  var allJuzData = [];
  var selectedOption = "full";
  var selectedJuz = null;

  function loadData() {
    fetch(WEB_APP_URL + "?action=getKhatam&gender=" + GENDER)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        allJuzData = data.juzList || [];
        renderKhatamTabs();
        renderGrid();
        updateStats();
        document.getElementById("last-updated").innerText =
          "Updated " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      })
      .catch(function() {
        document.getElementById("juz-grid").innerHTML =
          '<div class="loading">Could not load khatam. Check connection.</div>';
      });
  }

  function getKhatamCount() {
    // Each khatam is 30 juz. Work out how many khatams exist.
    return Math.ceil(allJuzData.length / 30) || 1;
  }

  function isKhatamFull(khatamNum) {
    var start = (khatamNum - 1) * 30;
    var slice = allJuzData.slice(start, start + 30);
    return slice.length === 30 && slice.every(function(j) { return j.status === "Full" || j.status === "Half" && j.claimer2Name; });
  }

  function renderKhatamTabs() {
    var count = getKhatamCount();
    // Show next khatam tab if current one is full
    var showCount = count;
    if (isKhatamFull(count)) showCount = count + 1;

    var html = "";
    for (var i = 1; i <= showCount; i++) {
      var locked = i > count;
      var active = i === currentKhatam;
      html += '<button class="khatam-tab' + (active ? " active" : "") + (locked ? " locked" : "") + '" '
        + 'onclick="switchKhatam(' + i + ')">'
        + 'Khatam ' + i
        + (locked ? ' üîí' : '')
        + '</button>';
    }
    document.getElementById("khatam-tabs").innerHTML = html;
  }

  function switchKhatam(num) {
    var count = getKhatamCount();
    if (num > count) return; // locked
    currentKhatam = num;
    renderKhatamTabs();
    renderGrid();
    updateStats();
  }

  function getCurrentJuz() {
    var start = (currentKhatam - 1) * 30;
    return allJuzData.slice(start, start + 30);
  }

  function renderGrid() {
    var juzList = getCurrentJuz();
    var grid = document.getElementById("juz-grid");

    if (juzList.length === 0) {
      grid.innerHTML = '<div class="loading">No juz data found.</div>';
      return;
    }

    var html = "";
    juzList.forEach(function(j) {
      var statusClass = "status-" + j.status.toLowerCase();
      if (j.completed) statusClass = "status-completed";

      var claimersHtml = "";
      if (j.status === "Full" && j.claimer1Name === j.claimer2Name) {
        claimersHtml = '<div class="claimer-line">' + escapeHtml(j.claimer1Name) + '</div>';
      } else if (j.status === "Full") {
        claimersHtml = '<div class="claimer-line"><span class="half-label">¬Ω</span> ' + escapeHtml(j.claimer1Name) + '</div>'
          + '<div class="claimer-line"><span class="half-label">¬Ω</span> ' + escapeHtml(j.claimer2Name) + '</div>';
      } else if (j.status === "Half") {
        claimersHtml = '<div class="claimer-line"><span class="half-label">¬Ω</span> ' + escapeHtml(j.claimer1Name) + '</div>'
          + '<div class="claimer-line"><span class="half-label">¬Ω</span> <em style="color:var(--muted);font-style:italic;font-size:10px;">open</em></div>';
      }

      var completedStar = j.completed ? '<div class="completed-star">‚úì Completed</div>' : "";

      html += '<div class="juz-card ' + statusClass + '" onclick="openModal(' + j.juz + ')">'
        + '<div class="juz-status-dot"></div>'
        + '<div class="juz-number">' + j.juz + '</div>'
        + '<div class="juz-label">Juz</div>'
        + '<div class="juz-claimers">' + claimersHtml + '</div>'
        + completedStar
        + '</div>';
    });

    grid.innerHTML = html;
  }

  function updateStats() {
    var juzList = getCurrentJuz();
    var free = juzList.filter(function(j) { return j.status === "Free"; }).length;
    var claimed = juzList.filter(function(j) { return j.status !== "Free"; }).length;
    var completed = juzList.filter(function(j) { return j.completed; }).length;

    document.getElementById("stat-free").innerText = free;
    document.getElementById("stat-claimed").innerText = claimed;
    document.getElementById("stat-completed").innerText = completed;
  }

  function openModal(juzNum) {
    selectedJuz = juzNum;
    selectedOption = "full";

    var juzData = allJuzData.find(function(j) { return j.juz === juzNum; });
    document.getElementById("modal-title").innerText = "Juz " + juzNum;
    document.getElementById("modal-feedback").innerText = "";
    document.getElementById("claim-name").value = "";

    var claimOptions = document.getElementById("claim-options");
    var claimBtn = document.getElementById("claim-btn");
    var completeSection = document.getElementById("complete-section");

    // Reset options
    document.getElementById("opt-full").classList.add("selected");
    document.getElementById("opt-half").classList.remove("selected");

    if (juzData.status === "Full") {
      // Already fully claimed ‚Äî only show complete option
      claimOptions.style.display = "none";
      claimBtn.style.display = "none";
      document.getElementById("modal-subtitle").innerText = "This juz is fully claimed.";
      document.getElementById("modal-field") && (document.querySelector(".modal-field").style.display = "none");
      completeSection.style.display = juzData.completed ? "none" : "block";
    } else if (juzData.status === "Half") {
      // Half claimed ‚Äî only half option available
      claimOptions.style.display = "grid";
      claimBtn.style.display = "block";
      document.getElementById("opt-full").style.display = "none";
      document.getElementById("opt-half").classList.add("selected");
      document.getElementById("opt-full").classList.remove("selected");
      selectedOption = "half";
      document.getElementById("modal-subtitle").innerText = "One half is still available.";
      document.querySelector(".modal-field").style.display = "block";
      completeSection.style.display = "none";
    } else {
      // Free
      claimOptions.style.display = "grid";
      claimBtn.style.display = "block";
      document.getElementById("opt-full").style.display = "block";
      document.getElementById("modal-subtitle").innerText = "Choose how you'd like to claim";
      document.querySelector(".modal-field").style.display = "block";
      completeSection.style.display = "none";
    }

    document.getElementById("modal-overlay").classList.add("open");
  }

  function closeModal(event) {
    if (event.target === document.getElementById("modal-overlay")) {
      closeModalDirect();
    }
  }

  function closeModalDirect() {
    document.getElementById("modal-overlay").classList.remove("open");
    // Reset modal state
    document.getElementById("opt-full").style.display = "block";
    document.getElementById("claim-options").style.display = "grid";
    document.getElementById("claim-btn").style.display = "block";
    document.querySelector(".modal-field").style.display = "block";
  }

  function selectOption(option) {
    selectedOption = option;
    document.getElementById("opt-full").classList.toggle("selected", option === "full");
    document.getElementById("opt-half").classList.toggle("selected", option === "half");
  }

  function claimJuz() {
    var name = document.getElementById("claim-name").value.trim();
    var feedback = document.getElementById("modal-feedback");
    var btn = document.getElementById("claim-btn");

    if (!name) { feedback.innerText = "Please enter your name"; return; }

    btn.disabled = true;
    feedback.innerText = "Claiming...";

    var isHalf = selectedOption === "half";
    fetch(WEB_APP_URL + "?action=claimJuz&juz=" + selectedJuz + "&name=" + encodeURIComponent(name) + "&half=" + isHalf + "&gender=" + GENDER)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          feedback.innerText = "Claimed! ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá ÿÆŸäÿ±ÿß ü§ç";
          setTimeout(function() {
            closeModalDirect();
            loadData();
          }, 1200);
        } else {
          feedback.innerText = data.error || "Something went wrong";
        }
        btn.disabled = false;
      })
      .catch(function() {
        feedback.innerText = "Could not claim. Check your connection.";
        btn.disabled = false;
      });
  }

  function completeJuz() {
    var name = prompt("Enter your name to confirm completion:");
    if (!name) return;

    fetch(WEB_APP_URL + "?action=completeJuz&juz=" + selectedJuz + "&name=" + encodeURIComponent(name) + "&gender=" + GENDER)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          closeModalDirect();
          loadData();
        }
      })
      .catch(function() {});
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  loadData();
  setInterval(loadData, 60000);
</script>

</body>
</html>
